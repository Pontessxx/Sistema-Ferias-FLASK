{% extends "base.html" %}
{% block content %}

<!-- =============================================================
     TÍTULO PRINCIPAL DA PÁGINA
     ============================================================= -->
<h1>Cadastro de Férias</h1>

<!-- =============================================================
     FORMULÁRIO DE CADASTRO / ATUALIZAÇÃO DE FÉRIAS
     - Este formulário permite adicionar um novo registro ou atualizar
       um registro existente quando carregado pela função carregarFerias().
     - O campo oculto ID decide se é criação ou edição.
     ============================================================= -->
<form action="/adicionar-ferias" method="POST" class="form-section" id="formFerias">

    <!-- ID oculto usado para edição -->
    <input type="hidden" id="ferias_id" name="ferias_id">

    <!-- ============================
         CAMPO: Funcionário
         - Lista vem do backend
         - data-saldo contém saldo de férias calculado via Python
         ============================ -->
    <div class="form-group">
        <label>Funcionário:</label>
        <select name="funcionario_id" id="funcionario_id" required onchange="atualizarSaldo()">
            <option value="">Selecione...</option>
            {% for f in funcionarios %}
                <option value="{{ f[0] }}" data-saldo="{{ f[2] }}">{{ f[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Mostra o saldo de férias conforme usuário seleciona funcionário -->
    <div class="form-group">
        <label id="label_saldo">Saldo de férias:</label>
        <span id="span_saldo">selecione um funcionário</span>
    </div>

    <!-- ============================
         CAMPO: Agendado no SAP
         ============================ -->
    <div class="form-group">
        <label>Agendado SAP:</label>
        <select name="agendado_sap" id="agendado_sap">
            <option value="sim">Sim</option>
            <option value="não">Não</option>
        </select>
    </div>

    <!-- ============================
         CAMPO: Abono pecuniário
         ============================ -->
    <div class="form-group">
        <label>Abono Pecuniário:</label>
        <select name="abono_peculiario" id="abono_peculiario">
            <option value="sim">Sim</option>
            <option value="não" selected>Não</option>
        </select>
    </div>

    <!-- ============================
         CAMPO: Data de início
         ============================ -->
    <div class="form-group">
        <label>Data de início:</label>
        <input type="date" name="inicio" id="inicio" required>
    </div>

    <!-- ============================
         CAMPO: Data de término
         ============================ -->
    <div class="form-group">
        <label>Data de término:</label>
        <input type="date" name="fim" id="fim" required>
    </div>

    <!-- BOTÕES DO FORMULÁRIO -->
    <div class="form-buttons">
        <button type="submit" id="btnSubmit" class="btn">Salvar</button>
        <button type="button" class="btn-secondary" onclick="limparFormulario()">Limpar</button>
    </div>

</form>

<!-- =============================================================
     LISTA DE FÉRIAS EXISTENTES
     ============================================================= -->
<h2>Férias cadastradas</h2>

<!-- =============================================================
     FILTROS (FUNCIONAM SEM RECARREGAR A PÁGINA)
     Cada filtro dispara applyFilters() → busca JSON da API → atualiza tabela
     ============================================================= -->
<div class="filters">

    <!-- Filtro: funcionário -->
    <select id="filtro_funcionario">
        <option value="">Todos funcionários</option>
        {% for f in funcionarios %}
            <option value="{{ f[0] }}">{{ f[1] }}</option>
        {% endfor %}
    </select>

    <!-- Filtro: ano -->
    <select id="filtro_ano">
        <option value="">Todos anos</option>
        <option value="{{ ano_atual }}">{{ ano_atual }}</option>
        <option value="{{ ano_proximo }}">{{ ano_proximo }}</option>
    </select>

    <!-- Filtro: mês -->
    <select id="filtro_mes">
        <option value="">Todos meses</option>
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
    </select>

    <!-- Filtro: abono -->
    <select id="filtro_abono">
        <option value="">Abono (todos)</option>
        <option value="sim">Com abono</option>
        <option value="não">Sem abono</option>
    </select>

    <!-- Filtro: SAP -->
    <select id="filtro_sap">
        <option value="">SAP (todos)</option>
        <option value="sim">Sim</option>
        <option value="não">Não</option>
    </select>

</div>


<!-- =============================================================
     TABELA DE FÉRIAS
     - O clique em cada linha executa carregarFerias(), que
       preenche o formulário para edição.
     - f é uma tupla enviada pelo backend com muitos dados.
     ============================================================= -->
<table class="table">
    <thead>
        <tr>
            <th>Funcionário</th>
            <th>Agendado SAP</th>
            <th>Período</th>
            <th>Abono</th>
            <th>Início</th>
            <th>Término</th>
            <th>Folga ({{ ano_atual }})</th>
            <th>Folga ({{ ano_proximo }})</th>
        </tr>
    </thead>

    <tbody>
    {% for f in ferias %}
    <tr class="clickable-row"
        onclick="carregarFerias(
            '{{ f[0] }}','{{ f[1] }}','{{ f[3] }}','{{ f[4] }}','{{ f[5] }}',
            '{{ f[10] }}','{{ f[11] }}','{{ f[12] }}','{{ f[13] }}'
        )">

        <td>{{ f[2] }}</td>
        <td>{{ f[3] }}</td>
        <td>{{ f[4] }} dias</td>
        <td>{{ f[5] }}</td>
        <td>{{ f[6] }}</td>
        <td>{{ f[7] }}</td>
        <td>{{ f[8] or '-' }}</td>
        <td>{{ f[9] or '-' }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<script>
/* =============================================================
   CARREGA UM REGISTRO EXISTENTE DE FÉRIAS NO FORMULÁRIO
   - Usado quando usuário clica em uma linha da tabela
   - Preenche todos os campos e troca ação do formulário
   ============================================================= */
function carregarFerias(id, funcionarioId, sap, dias, abono, inicioISO, fimISO, folgaAntISO, folgaAnoISO) {

    document.getElementById("ferias_id").value = id;
    document.getElementById("funcionario_id").value = funcionarioId;

    // Atualiza saldo de férias do funcionário
    fetch(`/saldo/${funcionarioId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("span_saldo").innerText =
                data.saldo + " dias restantes";
        });

    // Preenche os campos
    document.getElementById("agendado_sap").value = sap;
    document.getElementById("abono_peculiario").value = abono;

    document.getElementById("inicio").value = inicioISO;
    document.getElementById("fim").value = fimISO;

    // Troca para modo atualização
    document.getElementById("formFerias").action = "/atualizar-ferias/" + id;
    document.getElementById("btnSubmit").innerText = "Atualizar Férias";
}

/* =============================================================
   ATUALIZA SALDO QUANDO SELECIONA FUNCIONÁRIO
   ============================================================= */
function atualizarSaldo() {
    let id = document.getElementById("funcionario_id").value;
    if (!id) return;

    fetch(`/saldo/${id}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("span_saldo").innerText =
                data.saldo + " dias restantes";
        });
}

/* =============================================================
   LIMPAR FORMULÁRIO (VOLTA PARA MODO "ADICIONAR")
   ============================================================= */
function limparFormulario() {
    document.getElementById("ferias_id").value = "";
    document.getElementById("formFerias").action = "/adicionar-ferias";

    document.getElementById("funcionario_id").value = "";
    document.getElementById("span_saldo").innerText = "selecione um funcionário";

    document.getElementById("agendado_sap").value = "não";
    document.getElementById("abono_peculiario").value = "não";
    document.getElementById("inicio").value = "";
    document.getElementById("fim").value = "";
    document.getElementById("btnSubmit").innerText = "Salvar";
}

/* =============================================================
   FILTROS DINÂMICOS — atualização sem reload
   ============================================================= */
function aplicarFiltros() {
    let funcionario = document.getElementById("filtro_funcionario").value;
    let ano = document.getElementById("filtro_ano").value;
    let mes = document.getElementById("filtro_mes").value;
    let abono = document.getElementById("filtro_abono").value;
    let sap = document.getElementById("filtro_sap").value;

    fetch("/filtrar-ferias", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `funcionario_id=${funcionario}&ano=${ano}&mes=${mes}&abono=${abono}&sap=${sap}`
    })
    .then(res => res.json())
    .then(lista => atualizarTabela(lista));
}

/* =============================================================
   ATUALIZA TABELA SEM RECARREGAR PÁGINA
   ============================================================= */
function atualizarTabela(lista) {
    let tbody = document.querySelector(".table tbody");
    tbody.innerHTML = "";

    lista.forEach(f => {
        tbody.innerHTML += `
            <tr>
                <td>${f.funcionario}</td>
                <td>${f.sap}</td>
                <td>${f.dias} dias</td>
                <td>${f.abono}</td>
                <td>${f.inicio}</td>
                <td>${f.fim}</td>
                <td>-</td>
                <td>-</td>
            </tr>
        `;
    });
}

/* =============================================================
   EVENTOS: DISPARA FILTROS EM TEMPO REAL
   ============================================================= */
document.getElementById("filtro_funcionario").addEventListener("change", aplicarFiltros);
document.getElementById("filtro_ano").addEventListener("change", aplicarFiltros);
document.getElementById("filtro_mes").addEventListener("change", aplicarFiltros);
document.getElementById("filtro_abono").addEventListener("change", aplicarFiltros);
document.getElementById("filtro_sap").addEventListener("change", aplicarFiltros);

</script>

{% endblock %}
