{% extends "base.html" %}
{% block content %}

<h1>Cadastro de Férias</h1>

<form action="/adicionar-ferias" method="POST" class="form-section" id="formFerias">

    <input type="hidden" id="ferias_id" name="ferias_id">

    <div class="form-group">
        <label>Funcionário:</label>
        <select name="funcionario_id" id="funcionario_id" required>
            <option value="">Selecione...</option>
            {% for f in funcionarios %}
                <option value="{{ f[0] }}" data-saldo="{{ f[2] }}">{{ f[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label id="label_saldo">Saldo de férias:</label>
        <span id="span_saldo">selecione um funcionário</span>
    </div>

    <div class="form-group">
        <label>Agendado SAP:</label>
        <select name="agendado_sap" id="agendado_sap">
            <option value="sim">Sim</option>
            <option value="não">Não</option>
        </select>
    </div>

    <div class="form-group">
        <label>Abono Pecuniário:</label>
        <select name="abono_peculiario" id="abono_peculiario">
            <option value="sim">Sim</option>
            <option value="não" selected>Não</option>
        </select>
    </div>

    <div class="form-group">
        <label>Data de início:</label>
        <input type="date" name="inicio" id="inicio" required>
    </div>

    <div class="form-group">
        <label>Data de término:</label>
        <input type="date" name="fim" id="fim" required>
    </div>


    <div class="form-buttons">
        <button type="submit" id="btnSubmit" class="btn">Salvar</button>
        <button type="button" class="btn-secondary" onclick="limparFormulario()">Limpar</button>
    </div>
</form>



<h2>Folga Assiduidade</h2>

<form action="/adicionar-folga" method="POST" id="formFolga" class="form-section">

    <input type="hidden" id="folga_id" name="folga_id">

    <div class="form-group">
        <label>Funcionário:</label>
        <select name="funcionario_folga_id" id="funcionario_folga_id" required>
            <option value="">Selecione...</option>
            {% for f in funcionarios %}
                <option value="{{ f[0] }}">{{ f[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Ano da folga:</label>
        <select name="ano" id="ano" required>
            <option value="{{ ano_atual }}">{{ ano_atual }}</option>
            <option value="{{ ano_proximo }}">{{ ano_proximo }}</option>
        </select>
    </div>

    <div class="form-group">
        <label>Data da folga:</label>
        <input type="date" name="data_folga" id="data_folga" required>
    </div>

    
    <div class="form-buttons">
        <button type="submit" form="formFolga" id="btnFolga" class="btn">Salvar Folga</button>
        <button type="button" id="btnExcluirFolga" class="btn-secondary" onclick="excluirFolga()" style="display:none;">Excluir Folga</button>
    </div>
</form>

<hr>

<h2>Férias cadastradas</h2>

<table class="table">
    <tr>
        <th>Funcionário</th>
        <th>Agendado SAP</th>
        <th>Período</th>
        <th>Abono</th>
        <th>Início</th>
        <th>Término</th>
        <th>Folga ({{ ano_atual }})</th>
        <th>Folga ({{ ano_proximo }})</th>
    </tr>

    {% for f in ferias %}
    <tr class="clickable-row"
        onclick="carregarFerias(
            '{{ f[0] }}','{{ f[1] }}','{{ f[3] }}','{{ f[4] }}','{{ f[5] }}',
            '{{ f[10] }}','{{ f[11] }}','{{ f[12] }}','{{ f[13] }}'
        )">
        <td>{{ f[2] }}</td>
        <td>{{ f[3] }}</td>
        <td>{{ f[4] }} dias</td>
        <td>{{ f[5] }}</td>
        <td>{{ f[6] }}</td>
        <td>{{ f[7] }}</td>
        <td>{{ f[8] or '-' }}</td>
        <td>{{ f[9] or '-' }}</td>
    </tr>
    {% endfor %}
</table>


<script>

function carregarFerias(id, funcionarioId, sap, dias, abono, inicioISO, fimISO, folgaAntISO, folgaAnoISO) {

    document.getElementById("ferias_id").value = id;
    document.getElementById("funcionario_id").value = funcionarioId;

    let saldo = document.querySelector(`option[value="${funcionarioId}"]`).dataset.saldo;
    document.getElementById("span_saldo").innerText = saldo + " dias restantes";

    document.getElementById("agendado_sap").value = sap;
    document.getElementById("abono_peculiario").value = abono;

    document.getElementById("inicio").value = inicioISO;
    document.getElementById("fim").value = fimISO;
    // document.getElementById("folga_ano_anterior").value = folgaAntISO;
    document.getElementById("folga_ano").value = folgaAnoISO;

    document.getElementById("formFerias").action = "/atualizar-ferias/" + id;
    document.getElementById("btnSubmit").innerText = "Atualizar Férias";
}


document.getElementById("funcionario_id").addEventListener("change", function() {
    let saldo = this.options[this.selectedIndex].dataset.saldo || "";
    document.getElementById("span_saldo").innerText = saldo + " dias restantes";
});

function limparFormulario() {
    document.getElementById("ferias_id").value = "";
    document.getElementById("formFerias").action = "/adicionar-ferias";

    document.getElementById("funcionario_id").value = "";
    document.getElementById("span_saldo").innerText = "selecione um funcionário";

    document.getElementById("agendado_sap").value = "não";
    document.getElementById("abono_peculiario").value = "não";
    document.getElementById("inicio").value = "";
    document.getElementById("fim").value = "";
    // document.getElementById("folga_ano_anterior").value = "";
    document.getElementById("folga_ano").value = "";

    document.getElementById("btnSubmit").innerText = "Salvar";
}


// ===============================
//      CONTROLE DE FOLGA
// ===============================

// detecta mudanças
document.getElementById("funcionario_folga_id").addEventListener("change", verificarFolga);
document.getElementById("ano").addEventListener("change", verificarFolga);

function verificarFolga() {

    const funcionarioId = document.getElementById("funcionario_folga_id").value;
    const ano = document.getElementById("ano").value;

    if (!funcionarioId || !ano) return;

    fetch("/buscar-folga", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `funcionario_id=${funcionarioId}&ano=${ano}`
    })
    .then(res => res.json())
    .then(data => {

        if (data.id) {
            // Já existe folga → modo atualização
            document.getElementById("folga_id").value = data.id;
            document.getElementById("data_folga").value = data.data;

            document.getElementById("formFolga").action = `/atualizar-folga/${data.id}`;
            document.getElementById("btnFolga").innerText = "Atualizar Folga";
            document.getElementById("btnExcluirFolga").style.display = "inline-block";

        } else {
            // Não existe → cadastrar
            document.getElementById("folga_id").value = "";
            document.getElementById("data_folga").value = "";

            document.getElementById("formFolga").action = "/adicionar-folga";
            document.getElementById("btnFolga").innerText = "Salvar Folga";
            document.getElementById("btnExcluirFolga").style.display = "none";
        }
    });
}

function excluirFolga() {
    const id = document.getElementById("folga_id").value;

    if (!id)
        return alert("Erro: sem ID da folga.");

    window.location.href = `/deletar-folga/${id}`;
}

</script>

{% endblock %}
